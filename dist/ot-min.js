/*
 *    /\
 *   /  \ ot 0.0.11
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2013 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ ot may be freely distributed under the MIT license.
 */

if(ot===void 0)var ot={};if(ot.TextOp=function(){function t(t){if(!t)throw Error("assertion failed.")}function e(e){this.type=e,this.chars=null,this.text=null,this.attributes=null,"insert"===e?(this.text=arguments[1],t("string"==typeof this.text),this.attributes=arguments[2]||{},t("object"==typeof this.attributes)):"delete"===e?(this.chars=arguments[1],t("number"==typeof this.chars)):"retain"===e&&(this.chars=arguments[1],t("number"==typeof this.chars),this.attributes=arguments[2]||{},t("object"==typeof this.attributes))}return e.prototype.isInsert=function(){return"insert"===this.type},e.prototype.isDelete=function(){return"delete"===this.type},e.prototype.isRetain=function(){return"retain"===this.type},e.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},e.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},e.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},e}(),"object"==typeof module&&(module.exports=ot.TextOp),ot===void 0)var ot={};if(ot.TextOperation=function(t){function e(){return this.constructor!==e?new e:(this.ops=[],this.baseLength=0,this.targetLength=0,void 0)}var r=t.ot?t.ot.TextOp:require("./text-op");return e.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;this.ops.length>e;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},e.prototype.retain=function(t,e){if("number"!=typeof t||0>t)throw Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,e=e||{};var o=this.ops.length>0?this.ops[this.ops.length-1]:null;return o&&o.isRetain()&&o.attributesEqual(e)?o.chars+=t:this.ops.push(new r("retain",t,e)),this},e.prototype.insert=function(t,e){if("string"!=typeof t)throw Error("insert expects a string");if(""===t)return this;e=e||{},this.targetLength+=t.length;var o=this.ops.length>0?this.ops[this.ops.length-1]:null,n=this.ops.length>1?this.ops[this.ops.length-2]:null;return o&&o.isInsert()&&o.attributesEqual(e)?o.text+=t:o&&o.isDelete()?n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:(this.ops[this.ops.length-1]=new r("insert",t,e),this.ops.push(o)):this.ops.push(new r("insert",t,e)),this},e.prototype["delete"]=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||0>t)throw Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var e=this.ops.length>0?this.ops[this.ops.length-1]:null;return e&&e.isDelete()?e.chars+=t:this.ops.push(new r("delete",t)),this},e.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},e.prototype.clone=function(){for(var t=new e,r=0;this.ops.length>r;r++)this.ops[r].isRetain()?t.retain(this.ops[r].chars,this.ops[r].attributes):this.ops[r].isInsert()?t.insert(this.ops[r].text,this.ops[r].attributes):t["delete"](this.ops[r].chars);return t},e.prototype.toString=function(){var t=Array.prototype.map||function(t){for(var e=this,r=[],o=0,n=e.length;n>o;o++)r[o]=t(e[o]);return r};return t.call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},e.prototype.toJSON=function(){for(var t=[],e=0;this.ops.length>e;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},e.fromJSON=function(t){for(var r=new e,o=0,n=t.length;n>o;o++){var i=t[o],s={};"object"==typeof i&&(s=i,o++,i=t[o]),"number"==typeof i?i>0?r.retain(i,s):r["delete"](-i):r.insert(i,s)}return r},e.prototype.apply=function(t,e,r){var o=this;if(e=e||[],r=r||[],t.length!==o.baseLength)throw Error("The operation's base length must be equal to the string's length.");for(var n,i,s=[],a=0,h=0,p=this.ops,c=0,u=p.length;u>c;c++){var l=p[c];if(l.isRetain()){if(h+l.chars>t.length)throw Error("Operation can't retain more characters than are left in the string.");for(s[a++]=t.slice(h,h+l.chars),n=0;l.chars>n;n++){var f=e[h+n]||{},d={};for(i in f)d[i]=f[i];for(i in l.attributes)l.attributes[i]===!1?delete d[i]:d[i]=l.attributes[i];r.push(d)}h+=l.chars}else if(l.isInsert())for(s[a++]=l.text,n=0;l.text.length>n;n++){var g={};for(i in l.attributes)g[i]=l.attributes[i];r.push(g)}else h+=l.chars}if(h!==t.length)throw Error("The operation didn't operate on the whole string.");var y=s.join("");return y},e.prototype.invert=function(t){for(var r=0,o=new e,n=this.ops,i=0,s=n.length;s>i;i++){var a=n[i];a.isRetain()?(o.retain(a.chars),r+=a.chars):a.isInsert()?o["delete"](a.text.length):(o.insert(t.slice(r,r+a.chars)),r+=a.chars)}return o},e.prototype.compose=function(t){function r(t,e,r){var o,n={};for(o in t)n[o]=t[o];for(o in e)r&&e[o]===!1?delete n[o]:n[o]=e[o];return n}var o=this;if(o.targetLength!==t.baseLength)throw Error("The base length of the second operation has to be the target length of the first operation");for(var n,i=new e,s=o.clone().ops,a=t.clone().ops,h=0,p=0,c=s[h++],u=a[p++];;){if(c===void 0&&u===void 0)break;if(c&&c.isDelete())i["delete"](c.chars),c=s[h++];else if(u&&u.isInsert())i.insert(u.text,u.attributes),u=a[p++];else{if(c===void 0)throw Error("Cannot compose operations: first operation is too short.");if(u===void 0)throw Error("Cannot compose operations: fist operation is too long.");if(c.isRetain()&&u.isRetain())n=r(c.attributes,u.attributes),c.chars>u.chars?(i.retain(u.chars,n),c.chars-=u.chars,u=a[p++]):c.chars===u.chars?(i.retain(c.chars,n),c=s[h++],u=a[p++]):(i.retain(c.chars,n),u.chars-=c.chars,c=s[h++]);else if(c.isInsert()&&u.isDelete())c.text.length>u.chars?(c.text=c.text.slice(u.chars),u=a[p++]):c.text.length===u.chars?(c=s[h++],u=a[p++]):(u.chars-=c.text.length,c=s[h++]);else if(c.isInsert()&&u.isRetain())n=r(c.attributes,u.attributes,!0),c.text.length>u.chars?(i.insert(c.text.slice(0,u.chars),n),c.text=c.text.slice(u.chars),u=a[p++]):c.text.length===u.chars?(i.insert(c.text,n),c=s[h++],u=a[p++]):(i.insert(c.text,n),u.chars-=c.text.length,c=s[h++]);else{if(!c.isRetain()||!u.isDelete())throw Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(u));c.chars>u.chars?(i["delete"](u.chars),c.chars-=u.chars,u=a[p++]):c.chars===u.chars?(i["delete"](u.chars),c=s[h++],u=a[p++]):(i["delete"](c.chars),u.chars-=c.chars,c=s[h++])}}}return i},e.prototype.shouldBeComposedWith=function(t){function e(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function r(t){return t.ops[0].isRetain()?t.ops[0].chars:0}if(this.isNoop()||t.isNoop())return!0;var o=r(this),n=r(t),i=e(this),s=e(t);return i&&s?i.isInsert()&&s.isInsert()?o+i.text.length===n:i.isDelete()&&s.isDelete()?n+s.chars===o||o===n:!1:!1},e.transformAttributes=function(t,e){var r,o={},n={},i={};for(r in t)i[r]=!0;for(r in e)i[r]=!0;for(r in i){var s=t[r],a=e[r];null==s?n[r]=a:null==a?o[r]=s:s===a||(o[r]=s)}return[o,n]},e.transform=function(t,r){if(t.baseLength!==r.baseLength)throw Error("Both operations have to have the same base length");for(var o=new e,n=new e,i=t.clone().ops,s=r.clone().ops,a=0,h=0,p=i[a++],c=s[h++];;){if(p===void 0&&c===void 0)break;if(p&&p.isInsert())o.insert(p.text,p.attributes),n.retain(p.text.length),p=i[a++];else if(c&&c.isInsert())o.retain(c.text.length),n.insert(c.text,c.attributes),c=s[h++];else{if(p===void 0)throw Error("Cannot transform operations: first operation is too short.");if(c===void 0)throw Error("Cannot transform operations: first operation is too long.");var u;if(p.isRetain()&&c.isRetain()){var l=e.transformAttributes(p.attributes,c.attributes);p.chars>c.chars?(u=c.chars,p.chars-=c.chars,c=s[h++]):p.chars===c.chars?(u=c.chars,p=i[a++],c=s[h++]):(u=p.chars,c.chars-=p.chars,p=i[a++]),o.retain(u,l[0]),n.retain(u,l[1])}else if(p.isDelete()&&c.isDelete())p.chars>c.chars?(p.chars-=c.chars,c=s[h++]):p.chars===c.chars?(p=i[a++],c=s[h++]):(c.chars-=p.chars,p=i[a++]);else if(p.isDelete()&&c.isRetain())p.chars>c.chars?(u=c.chars,p.chars-=c.chars,c=s[h++]):p.chars===c.chars?(u=c.chars,p=i[a++],c=s[h++]):(u=p.chars,c.chars-=p.chars,p=i[a++]),o["delete"](u);else{if(!p.isRetain()||!c.isDelete())throw Error("The two operations aren't compatible");p.chars>c.chars?(u=c.chars,p.chars-=c.chars,c=s[h++]):p.chars===c.chars?(u=p.chars,p=i[a++],c=s[h++]):(u=p.chars,c.chars-=p.chars,p=i[a++]),n["delete"](u)}}}return[o,n]},e}(this),"object"==typeof module&&(module.exports=ot.TextOperation),ot===void 0)var ot={};if(ot.Cursor=function(t){function e(t,e){this.position=t,this.selectionEnd=e}return t.ot?t.ot.TextOperation:require("./text-operation"),e.fromJSON=function(t){return new e(t.position,t.selectionEnd)},e.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},e.prototype.compose=function(t){return t},e.prototype.transform=function(t){function r(e){for(var r=e,o=t.ops,n=0,i=t.ops.length;i>n&&(o[n].isRetain()?e-=o[n].chars:o[n].isInsert()?r+=o[n].text.length:(r-=Math.min(e,o[n].chars),e-=o[n].chars),!(0>e));n++);return r}var o=r(this.position);return this.position===this.selectionEnd?new e(o,o):new e(o,r(this.selectionEnd))},e}(this),"object"==typeof module&&(module.exports=ot.Cursor),ot===void 0)var ot={};if(ot.WrappedOperation=function(){function t(t,e){this.wrapped=t,this.meta=e}function e(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function r(t,r){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(r);var o={};return e(t,o),e(r,o),o}return r}function o(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.meta;return new t(this.wrapped.invert.apply(this.wrapped,arguments),e&&"object"==typeof e&&"function"==typeof e.invert?e.invert.apply(e,arguments):e)},t.prototype.compose=function(e){return new t(this.wrapped.compose(e.wrapped),r(this.meta,e.meta))},t.transform=function(e,r){var n=e.wrapped.constructor.transform,i=n(e.wrapped,r.wrapped);return[new t(i[0],o(e.meta,r.wrapped)),new t(i[1],o(r.meta,e.wrapped))]},t}(this),"object"==typeof module&&(module.exports=ot.WrappedOperation),ot===void 0)var ot={};if(ot.UndoManager=function(){function t(t){this.maxItems=t||50,this.state=r,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(t,e){for(var r=[],o=e.constructor,n=t.length-1;n>=0;n--){var i=o.transform(t[n],e);"function"==typeof i[0].isNoop&&i[0].isNoop()||r.push(i[0]),e=i[1]}return r.reverse()}var r="normal",o="undoing",n="redoing";return t.prototype.add=function(t,e){if(this.state===o)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===n)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=e(this.undoStack,t),this.redoStack=e(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=o,0===this.undoStack.length)throw Error("undo not possible");t(this.undoStack.pop()),this.state=r},t.prototype.performRedo=function(t){if(this.state=n,0===this.redoStack.length)throw Error("redo not possible");t(this.redoStack.pop()),this.state=r},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===o},t.prototype.isRedoing=function(){return this.state===n},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),ot===void 0)var ot={};ot.Client=function(){function t(t){this.revision=t,this.state=n}function e(){}function r(t){this.outstanding=t}function o(t,e){this.outstanding=t,this.buffer=e}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.revision++,this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformCursor=function(t){return this.state.transformCursor(t)},t.prototype.sendOperation=function(){throw Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(){throw Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new r(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(){throw Error("There is no pending operation.")},e.prototype.transformCursor=function(t){return t};var n=new e;return t.AwaitingConfirm=r,r.prototype.applyClient=function(t,e){return new o(this.outstanding,e)},r.prototype.applyServer=function(t,e){var o=e.constructor.transform(this.outstanding,e);return t.applyOperation(o[1]),new r(o[0])},r.prototype.serverAck=function(){return n},r.prototype.transformCursor=function(t){return t.transform(this.outstanding)},r.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t.AwaitingWithBuffer=o,o.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new o(this.outstanding,r)},o.prototype.applyServer=function(t,e){var r=e.constructor.transform,n=r(this.outstanding,e),i=r(this.buffer,n[1]);return t.applyOperation(i[1]),new o(n[0],i[0])},o.prototype.serverAck=function(t){return t.sendOperation(t.revision,this.buffer),new r(this.buffer)},o.prototype.transformCursor=function(t){return t.transform(this.outstanding).transform(this.buffer)},o.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t}(this),"object"==typeof module&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(){function t(t){this.cm=t,this.ignoreNextChange=!1,this.oldValue=this.cm.getValue(),r(this,"onChange"),r(this,"onCursorActivity"),r(this,"onFocus"),r(this,"onBlur"),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}function e(t,e){if(!t)throw Error(e||"assertion error")}function r(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}var o=ot.TextOperation,n=ot.Cursor;t.prototype.detach=function(){this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},t.operationFromCodeMirrorChange=function(t,e){function r(t){for(var e=(t.line,t.ch),r=0,o=0;t.line>o;o++)r+=p[o].length+1;return r+=e}function n(){for(var t=0,e=0,r=p.length;r>e;e++)t+=p[e].length;return t+p.length-1}function i(t,e){if(t.line===e.line)return p[t.line].slice(t.ch,e.ch);for(var r=p[t.line].slice(t.ch)+"\n",o=t.line+1;e.line>o;o++)r+=p[o]+"\n";return r+=p[e.line].slice(0,e.ch)}function s(t,e,r){var o=t.slice(0),n=p[e.line].slice(0,e.ch),i=p[r.line].slice(r.ch);o[0]=n+o[0],o[o.length-1]+=i,o.unshift(r.line-e.line+1),o.unshift(e.line),p.splice.apply(p,o)}function a(t,e){var o=r(e.from),a=r(e.to),h=n();t.retain(o),t["delete"](i(e.from,e.to)),t.insert(e.text.join("\n")),t.retain(h-a),s(e.text,e.from,e.to)}var h=new o,p=e.split("\n");for(a(h,t);;){if(t=t.next,!t)break;var c=new o(h.revision+1);a(c,t),h=h.compose(c)}return h},t.applyOperationToCodeMirror=function(t,r){r.operation(function(){for(var o=t.ops,n=0,i=0,s=o.length;s>i;i++){var a=o[i];if(a.isRetain())n+=a.chars;else if(a.isInsert())r.replaceRange(a.text,r.posFromIndex(n)),n+=a.text.length;else if(a.isDelete()){var h=r.posFromIndex(n),p=r.posFromIndex(n+a.chars);r.replaceRange("",h,p)}}e(n===r.getValue().length)})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.onChange=function(e,r){if(!this.ignoreNextChange){var o=t.operationFromCodeMirrorChange(r,this.oldValue);this.trigger("change",this.oldValue,o)}this.ignoreNextChange=!1,this.oldValue=this.cm.getValue()},t.prototype.onCursorActivity=t.prototype.onFocus=function(){this.trigger("cursorActivity")},t.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},t.prototype.getValue=function(){return this.oldValue},t.prototype.getCursor=function(){function t(t,e){return t.line===e.line&&t.ch===e.ch}var e,r=this.cm,o=r.getCursor(),i=r.indexFromPos(o);if(r.somethingSelected()){var s=r.getCursor(!0),a=t(o,s)?r.getCursor(!1):s;e=r.indexFromPos(a)}else e=i;return new n(i,e)},t.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))};var i=function(){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var r=e.sheet;return function(e){t[e]||(t[e]=!0,r.insertRule(e,(r.cssRules||r.rules).length))}}();return t.prototype.setOtherCursor=function(t,e,r){var o=this.cm.posFromIndex(t.position);if(t.position===t.selectionEnd){var n=this.cm.cursorCoords(o),s=document.createElement("pre");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.innerHTML="&nbsp;",s.style.borderLeftColor=e,s.style.height=.9*(n.bottom-n.top)+"px",s.style.marginTop=n.top-n.bottom+"px",s.setAttribute("data-clientid",r),this.cm.addWidget(o,s,!1),{clear:function(){var t=s.parentNode;t&&t.removeChild(s)}}}var a=/^#([0-9a-fA-F]{6})$/.exec(e);if(!a)throw Error("only six-digit hex colors are allowed.");var h="selection-"+a[1],p="."+h+" { background: "+e+"; }";i(p);var c,u;return t.selectionEnd>t.position?(c=o,u=this.cm.posFromIndex(t.selectionEnd)):(c=this.cm.posFromIndex(t.selectionEnd),u=o),this.cm.markText(c,u,{className:h})},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},t.prototype.applyOperation=function(e){this.ignoreNextChange=!0,t.applyOperationToCodeMirror(e,this.cm)},t.prototype.registerUndo=function(t){this.cm.undo=t},t.prototype.registerRedo=function(t){this.cm.redo=t},t}(),ot.SocketIOAdapter=function(){function t(t){this.socket=t;var e=this;t.on("client_left",function(t){e.trigger("client_left",t)}).on("set_name",function(t,r){e.trigger("set_name",t,r)}).on("ack",function(){e.trigger("ack")}).on("operation",function(t,r,o){e.trigger("operation",r),e.trigger("cursor",t,o)}).on("cursor",function(t,r){e.trigger("cursor",t,r)}).on("reconnect",function(){e.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,r){this.socket.emit("operation",t,e,r)},t.prototype.sendCursor=function(t){this.socket.emit("cursor",t)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},t}(),ot.AjaxAdapter=function(){function t(t,e){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.revision=e,this.poll()}return t.prototype.poll=function(){var t=this;this.xhr=$.ajax({url:this.path+"revision/"+this.revision,type:"GET",dataType:"json",success:function(e){for(var r=e.operations,o=0;r.length>o;o++)t.trigger("operation",r[o]);t.revision+=r.length,t.poll()},error:function(e,r){"abort"!==r&&setTimeout(function(){t.poll()},500)}})},t.prototype.sendOperation=function(t,e,r){if(this.xhr&&this.xhr.abort(),t!==this.revision)throw Error("Revision numbers out of sync");var o=this;this.xhr=$.ajax({url:this.path+"revision/"+t,type:"POST",data:JSON.stringify({operation:e,cursor:r}),contentType:"application/json",processData:!1,success:function(t){for(var e=t.operations,r=0;e.length-1>r;r++)o.trigger("operation",e[r]);o.revision+=e.length,o.trigger("ack"),o.poll()},error:function(){setTimeout(function(){o.sendOperation(t,e,r)},500)}})},t.prototype.sendCursor=function(t){$.ajax({url:this.path+"cursor",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},t}(),ot.EditorClient=function(){function t(t,e){this.cursorBefore=t,this.cursorAfter=e}function e(t,e){this.clientId=t,this.cursor=e}function r(t,e,r,o,n){this.id=t,this.listEl=e,this.editorAdapter=r,this.name=o,this.li=document.createElement("li"),o&&(this.li.textContent=o,this.listEl.appendChild(this.li)),this.setColor(o?s(o):Math.random()),n&&this.updateCursor(n)}function o(t,e,r,o){c.call(this,t),this.serverAdapter=r,this.editorAdapter=o,this.undoManager=new l,this.initializeClientList(),this.initializeClients(e);var n=this;this.editorAdapter.registerCallbacks({change:function(t,e){n.onChange(t,e)},cursorActivity:function(){n.onCursorActivity()},blur:function(){n.onBlur()}}),this.editorAdapter.registerUndo(function(){n.undo()}),this.editorAdapter.registerRedo(function(){n.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){n.onClientLeft(t)},set_name:function(t,e){n.getClientObject(t).setName(e)},ack:function(){n.serverAck()},operation:function(t){n.applyServer(f.fromJSON(t))},cursor:function(t,e){e?n.getClientObject(t).updateCursor(n.transformCursor(u.fromJSON(e))):n.getClientObject(t).removeCursor()},reconnect:function(){n.serverReconnect()}})}function n(t,e,r){function o(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+o(t)+o(e)+o(r)}function i(t,e,r){if(0===e)return n(r,r,r);var o=.5>r?r*(1+e):r+e-e*r,i=2*r-o,s=function(t){return 0>t&&(t+=1),t>1&&(t-=1),1>6*t?i+6*(o-i)*t:1>2*t?o:2>3*t?i+6*(o-i)*(2/3-t):i};return n(s(t+1/3),s(t),s(t-1/3))}function s(t){for(var e=1,r=0;t.length>r;r++)e=17*(e+t.charCodeAt(r))%360;return e/360}function a(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}function h(t){return t[t.length-1]}function p(t){t.parentNode&&t.parentNode.removeChild(t)}var c=ot.Client,u=ot.Cursor,l=ot.UndoManager,f=ot.TextOperation,d=ot.WrappedOperation;return t.prototype.invert=function(){return new t(this.cursorAfter,this.cursorBefore)},t.prototype.compose=function(e){return new t(this.cursorBefore,e.cursorAfter)},t.prototype.transform=function(e){return new t(this.cursorBefore.transform(e),this.cursorAfter.transform(e))},e.fromJSON=function(t){return new e(t.clientId,t.cursor&&u.fromJSON(t.cursor))},e.prototype.transform=function(t){return new e(this.clientId,this.cursor&&this.cursor.transform(t))},r.prototype.setColor=function(t){this.hue=t,this.color=i(t,.75,.5),this.lightColor=i(t,.5,.9),this.li&&(this.li.style.color=this.color)},r.prototype.setName=function(t){this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(s(t))},r.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},r.prototype.remove=function(){this.li&&p(this.li),this.removeCursor()},r.prototype.removeCursor=function(){this.mark&&this.mark.clear()},a(o,c),o.prototype.initializeClients=function(t){this.clients={};for(var e in t)if(t.hasOwnProperty(e)){var o=t[e];o.clientId=e,this.clients[e]=new r(o.clientId,this.clientListEl,this.editorAdapter,o.name,o.cursor?u.fromJSON(o.cursor):null)}},o.prototype.getClientObject=function(t){var e=this.clients[t];return e?e:this.clients[t]=new r(t,this.clientListEl,this.editorAdapter)},o.prototype.onClientLeft=function(t){console.log("User disconnected: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},o.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},o.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(t)},o.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},o.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},o.prototype.onChange=function(e,r){var o=this.cursor;this.updateCursor();var n=new t(o,this.cursor),i=new d(r,n),s=this.undoManager.undoStack.length>0&&!this.undoManager.dontCompose&&h(this.undoManager.undoStack).wrapped.invert(e).shouldBeComposedWith(r);this.undoManager.add(i.invert(e),s),this.applyClient(r)},o.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},o.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},o.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},o.prototype.sendCursor=function(t){this.state instanceof c.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},o.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.cursor)},o.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new d(t,null))},o}();